<!DOCTYPE html>
<html>

	<head>
		<meta charset="utf-8"/>
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1, user-scalable=0"/>
		<link rel="stylesheet" type="text/css" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
		<link media="all" type="text/css" rel="stylesheet" href="css/game.css">
		<link href="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" rel="stylesheet" id="bootstrap-css">
		<script src="//maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
		<script src = "scripts/jQuery.js"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.3.0/socket.io.js"></script>
		<script type = "text/javascript" src = "scripts/socket.js"></script>
		<script type = "text/javascript" src = "localStorage/script.js"></script>

	</head>

	<body>

		<script>

		  var userFirstname, userLastname, userEmail, userId, userProfile;

		  function webShare(){

		  	if (navigator.share) {

		  		// let url = document.location.href;
		  		let url = "https://www.miyens.com/interactive";

				const canonicalElement = document.querySelector('link[rel=canonical]');

				if (canonicalElement !== null) {
				    url = canonicalElement.href;
				}

				// navigator.share({url: url});
			  navigator.share({
			      title: "I got Pingpong'ed Experience!",
			      text: "Amazing brand marketing experience by Miyens Interactive Team #miyensInteractive",
			      url: url,
			  })
			    .then(() => console.log('Successful share'))
			    .catch((error) => console.log('Error sharing', error));
			}
		  }


		  function getUserData(response){

				FB.api('/me', 'GET', {fields: 'first_name, last_name, email, id'}, function(response) {

                    userFirstname = response.first_name;
                    userLastname = response.last_name;
                    userEmail = response.email;
                    userId = response.id;
                    userProfile = 'https://graph.facebook.com/'+userId+'/picture?type=large';

                    // socket.emit("sendDataToServer",  {firstName: userFirstname, lastName: userLastname, email: userEmail, imageUrl: userProfile});

                    // startGame();

                });

      		// userFirstname = "jet";
        //             userLastname = "lee";
        //             userEmail = "ayaw@gmail.com";
        //             userId = "99";
        //             userProfile = 'https://graph.facebook.com/4/picture?type=large';

                    socket.emit("requestLocalStorageData");


		  }

		  //the host get the local storage data
		  socket.on("getLocalStorageData", function(){

		  		var data = loadData();

		  		socket.emit("sendLocalStorageData", data);

		  });

		  //the client now get the local storage data
		  socket.on("giveLocalStorageDataToClient", function(data){


		  		ifEmailExist(data);
		  		

		  });

		function ifEmailExist(data){

		  	var isExisting = null;
		  	  
		  	var found = 0;

            for (var i = 0; i < data.length; i++) {
            	
            	if (data[i][2] == userEmail){

            		found++;

            	}
            }

            if (found > 0){

            	isExisting = true;

            	alert("Email already exist!");

            }else{

            	isExisting = false;
            }


	       if (isExisting == false){

	            socket.emit("sendDataToServer",  {firstName: userFirstname, lastName: userLastname, email: userEmail, imageUrl: userProfile});

	            saveDataSpreadSheet({firstName: userFirstname, lastName: userLastname, email: userEmail, imageUrl: userProfile});

            	startGame();
            }



		}

		  window.fbAsyncInit = function() {
		    FB.init({
		      appId      : '806502046431924',
		      cookie     : true,
		      xfbml      : true,
		      version    : 'v4.0'
		    });
		      
		    FB.AppEvents.logPageView();   

		    FB.getLoginStatus(function(response) {   // Called after the JS SDK has been initialized.

		    	//checks if the user is connected on FB
		    	if (response.status === 'connected') {
					
					// //getUserData(response);
					FB.logout(function(response) {
					  // user is now logged out
					  console.log("user force log out");
					});

					//startGame();

				} else {
					console.log("user already log out");
				}
		      	
		    });     
		  };

		  (function(d, s, id){
		     var js, fjs = d.getElementsByTagName(s)[0];
		     if (d.getElementById(id)) {return;}
		     js = d.createElement(s); js.id = id;
		     js.src = "https://connect.facebook.net/en_US/sdk.js";
		     fjs.parentNode.insertBefore(js, fjs);
		   }(document, 'script', 'facebook-jssdk'));


		  function showFBLoginDialog(){

		  	//log in the user to FB, shows FB log in dialog
		  	FB.login(function(response) {

		  		//check if the user authenticate data access to the server
		  		if(response.authResponse){

		  			getUserData(response);
		  		}
		  		else{

		  			console.log("User did not log in");
		  		}

		  	}, { scope: 'email' });
		  }

		  function startGame(){
		  	$("#fbButton").addClass("hide");
            $("#startButton").removeClass("hide");
		  }

		</script>

		<div id="fb-root"></div>
		<script async defer crossorigin="anonymous" src="https://connect.facebook.net/en_US/sdk.js#xfbml=1&version=v4.0&appId=806502046431924&autoLogAppEvents=1"></script>

		<!--div id="unLocatedUser"><div class = "mainText"></div></div-->

		<div id = "gameContainer">

			<div id = "gameScreen">
				<div class="wrapper fadeInDown">
				  <div id="formContent">
				    <!-- Tabs Titles -->

				    <!-- Icon -->
				    <div class="fadeIn first">
				    </div>

				    <!-- Login Form -->
				    <!-- <form> -->
				      <input type="text" id="login" class="fadeIn second" name="login" placeholder="login">
				      <input type="text" id="password" class="fadeIn third" name="login" placeholder="password">
				      <input type="submit" class="fadeIn fourth" value="Log In" onclick="handleSignInClick();">
				    <!-- </form> -->

				  </div>
				</div>
				<div class = "mainText"><img src="images/title.png"/></div>
				<div class = "mainText"></div>
			</div>

			<div class = "displayTitle">
				<span>Bot</span>
				<img src="images/title.png"/>
				<span>Player</span>
			</div>

			<canvas id="gameScene"></canvas>

			<div class = "displayData">

				<div class = "displayData-blocks">
					<div>
						<div>Time: <span class = "timeCD">0</span></div>
					</div>
				</div>

				<div id = "userBlock" class = "displayData-blocks">
					<div id = "userImage"></div>
				</div>

				<div class = "displayData-blocks">
					<div>
						<div>Score: <span class = "playerScore">0</span></div>
					</div>
				</div>

			</div>
			
		</div>
		<canvas id="userInterface" class="controller"></canvas>

		

		<div id = "nonGameComponent">

			<div id = "loader"><div class ="loaderImage"></div></div>

			<div id = "panel">

				<div id = "introduction">
					<div class ="upperSection"><div class ="mainText">Welcome to Pick & Play</div></div>
					<div class ="lowerSection">
						<div class="action-blocks">

							<!-- <fb:login-button id = "fbButton" scope="public_profile,email" onlogin="showFBLoginDialog();" class="fb-login-button" data-width="" data-size="medium" data-button-type="continue_with" data-auto-logout-link="false" data-use-continue-as="false"></fb:login-button> -->

							<div id = "fbButton" class = "buttons" onclick="showFBLoginDialog()">Log in with Facebook</div>

							<div id = "startButton" class = "buttons hide" > Start</div>
						</div>
						<div class="action-blocks">
							<a href = ""  id = "agreementText">By logging in you accept the terms and conditions</a>
						</div>
					</div>
				</div>

				<div id = "win" class = "hide">

					<div class = "displayTitle"><img src ="images/title.png"/></div>

					<div><div class ="mainText">Congratulations, You win!</div></div>
					<div><div id="foodPhoto"></div><div id="qrCode"></div></div>
					<div>
						<div><a id = "downloadButton" download = "QR.jpg" onclick="downloadQR(this);">Download Coupon</a></div>
						<div><div id = "continueButton">Play Again</div></div>
						<div class="shareBtn" onclick="webShare();"><i class="ion-android-share-alt" style="font-size: 1.8em;"></i></div>
					</div>

				</div>

				<div id = "playAgain" class = "hide">

					<div class = "displayTitle"><img src ="images/title.png"/></div>
					<div>
						<div class ="mainText">Nice Game</div>
					</div>
					<div>
						<div id ="playAgainButton">Play Again</div>
					</div>
				</div>

				<div class="que-notif" style="display: none;">
					<div class="notification-text mainText"></div>	
				</div>
				
			</div>

		</div>

		<!-- <script type = "text/javascript" src = "socket.io/dist/socket.io.js"></script> -->
		
		<script src = "scripts/easeljs.min.js"></script>
		<script src = "scripts/preloadJS.js"></script>
		<script src = "scripts/game.js"></script>

		<script> 

			$(window).resize(function(){

				var getParentHeight = $(".displayData > div:nth-child(2)").height();

		        $("#userImage").width(getParentHeight+"px");
		        $("#userImage").height(getParentHeight+"px");
			});


		    function makeApiCall() {
		      var params = {
		        // The ID of the spreadsheet to retrieve data from.
		        spreadsheetId: '1935cO3tUbKUJbL78hTZAqOuu-DlXzveaDwZs3vpbkvc',  // TODO: Update placeholder value.

		        // The A1 notation of the values to retrieve.
		        range: 'Sheet1',  // TODO: Update placeholder value.

		        // How values should be represented in the output.
		        // The default render option is ValueRenderOption.FORMATTED_VALUE.
		        // valueRenderOption: '',  // TODO: Update placeholder value.

		        // How dates, times, and durations should be represented in the output.
		        // This is ignored if value_render_option is
		        // FORMATTED_VALUE.
		        // The default dateTime render option is [DateTimeRenderOption.SERIAL_NUMBER].
		        // dateTimeRenderOption: '',  // TODO: Update placeholder value.
		      };

		      var request = gapi.client.sheets.spreadsheets.values.get(params);
		      request.then(function(response) {
		        // TODO: Change code below to process the `response` object:
		        console.log(response.result);
		        $('.fadeInDown').css("display", "none");
		      }, function(reason) {
		        console.error('error: ' + reason.result.error.message);
		        $('.fadeInDown').css("display", "none");
		      });

		      var values = [
				  [
				  	'00006', 'jam', 'poy', '38', 'yes'
				    // Cell values ...
				  ],
				  // Additional rows ...
				];

		      var body = {
				  values: values
				};

		      var parameters = {
		        // The ID of the spreadsheet to retrieve data from.
		        spreadsheetId: '1935cO3tUbKUJbL78hTZAqOuu-DlXzveaDwZs3vpbkvc',  // TODO: Update placeholder value.

		        // The A1 notation of the values to retrieve.
		        range: 'Sheet1',  // TODO: Update placeholder value.
				valueInputOption: 'RAW',
				resource: body
		      };
				
				gapi.client.sheets.spreadsheets.values.append(parameters).then((response) => {
				  var result = response.result;
				  console.log(result);
				  console.log(`${result.updates.updatedCells} cells appended.`);
				});
		    }

		    function initClient() {
		      var API_KEY = 'AIzaSyCUT3e1siW4QQypigWAf6-hq8o4WKmjjEw';  // TODO: Update placeholder with desired API key.

		      var CLIENT_ID = '890056526823-7m96444deo91mr9jvlm9rmtf9eu3lkko.apps.googleusercontent.com';  // TODO: Update placeholder with desired client ID.

		      // TODO: Authorize using one of the following scopes:
		      //   'https://www.googleapis.com/auth/drive'
		      //   'https://www.googleapis.com/auth/drive.file'
		      //   'https://www.googleapis.com/auth/drive.readonly'
		      //   'https://www.googleapis.com/auth/spreadsheets'
		      //   'https://www.googleapis.com/auth/spreadsheets.readonly'
		      var SCOPE = 'https://www.googleapis.com/auth/spreadsheets';

		      gapi.client.init({
		        'apiKey': API_KEY,
		        'clientId': CLIENT_ID,
		        'scope': SCOPE,
		        'discoveryDocs': ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
		      }).then(function() {
		        gapi.auth2.getAuthInstance().isSignedIn.listen(updateSignInStatus);
		        updateSignInStatus(gapi.auth2.getAuthInstance().isSignedIn.get());
		      });


		    }

		    function handleClientLoad() {
		      gapi.load('client:auth2', initClient);
		    }

		    function updateSignInStatus(isSignedIn) {
		      if (isSignedIn) {
		        makeApiCall();
		      }
		    }

		    function handleSignInClick(event) {

		    	$('.fadeInDown').css("display", "none");
		      	gapi.auth2.getAuthInstance().signIn();
		    }

		    function handleSignOutClick(event) {
		      gapi.auth2.getAuthInstance().signOut();
		    }

		    function saveDataSpreadSheet(data){

		    	console.log(data);

		    	var API_KEY = 'AIzaSyCUT3e1siW4QQypigWAf6-hq8o4WKmjjEw';  // TODO: Update placeholder with desired API key.

		      	var CLIENT_ID = '890056526823-7m96444deo91mr9jvlm9rmtf9eu3lkko.apps.googleusercontent.com';

		    	console.log(data);

		    	var params = {
		        // The ID of the spreadsheet to retrieve data from.
		        spreadsheetId: '1935cO3tUbKUJbL78hTZAqOuu-DlXzveaDwZs3vpbkvc',  // TODO: Update placeholder value.

		        // The A1 notation of the values to retrieve.
		        range: 'Sheet1',  // TODO: Update placeholder value.

		      };

		    	var values = [
				  [
				  	'00005', 'jet', 'li', '88', 'no'
				    // Cell values ...
				  ],
				  // Additional rows ...
				];
				var body = {
				  values: values
				};
				gapi.client.sheets.spreadsheets.values.append(params).then((response) => {
				  var result = response.result;
				  console.log(result);
				  console.log(`${result.updates.updatedCells} cells appended.`);
				});
		    }



		</script>

		<script async defer src="https://apis.google.com/js/api.js" onload="this.onload=function(){};handleClientLoad()" onreadystatechange="if (this.readyState === 'complete') this.onload()"></script>
		
	</body>

</html>